// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('24([\'l\',\'13\',\'1w/k/V\',\'1w/23/R\'],3(l,13,V,R){a 4={r:\'x\'};4.22=3(){l.D(\'G/x/25\',{},3(7){a i=7.i;6(i.f>0){$(\'.8-h\').s()}w{$(\'.8-h\').1b()}l.13("#21",\'29\',7.i,Z);l.13("#28",\'27\',7.i,Z);1P(3(){4.1v()},2a)},j);n};4.1v=3(){$(\'.I-1h\').1q({1d:3(12,L){a 5=L.M(\'.k-2\').9(\'5\');a d=L.M(\'.k-2\').9(\'d\');4.16(5,12,d);4.B()}});$(\'.W-2\').y(\'g\').g(3(){a 5=$(c).M(\'.k-2\').9(\'5\');4.H(5,$(c).v(\'b\'))});$(\'.1z\').y(\'g\').g(3(){a b=$(c).q(\':1u\').v(\'b\');$(".W-2").v(\'b\',b);4.B();4.H(\'1Y\',b)});$(\'.8-14\').y(\'g\').g(3(){a 8=$(c);6(8.C(\'11\')){n}a m=$(c).m();8.C(\'11\',1).m(\'正在处理...\');l.D(\'G/x/14\',{},3(7){6(7.r!=1){8.Y(\'11\').m(m);6(7.i==0){A.O.s(7.i.E)}w{A.1V(7.i.E)}n}1O.1Q=l.1U(\'1E/1H\')},j)});$(\'.8-h\').y(\'g\').g(3(){4.1c()});$(\'.8-1g\').y(\'g\').g(3(){6($(\'.h-2:b\').p<=0){n}4.u()});$(\'.8-1n\').y(\'g\').g(3(){6($(\'.h-2:b\').p<=0){n}4.1N()});$(\'.1f\').y(\'g\').g(3(){a b=$(c).q(\':1u\').v(\'b\');$(".h-2").v(\'b\',b);4.1e()});$(\'.h-2\').y(\'g\').g(3(){4.1e()});$(\'.1p-1o\').y(\'g\').g(3(e){6(4.r==\'h\'){e.1W();4.1F(c)}});4.B()};4.1c=3(){6($(\'.k-2\').p<=0){$(\'.8-h\').u();$(\'.S\').u();$(\'.1l\').u();$(\'#L\').u();$(\'.20-1Z\').s();n}$(\'.I-1X-26\').N(3(2m,2){6($(2).q(\'.k-2\').p<=0){$(2).2q(\'.I-2p\').u();$(2).u()}});6(4.r==\'x\'){$(\'.h-2\').v(\'b\',Z);$(\'.1f\').v(\'b\',Z);$(\'.S\').1b();$(\'.1l\').s();4.r=\'h\';$(\'.8-h\').m(\'完成\')}w{$(\'.S\').s();$(\'.1l\').1b();4.r=\'x\';$(\'.8-h\').m(\'编辑\')}};4.H=3(5,H){l.D(\'G/x/H\',{19:5,H:H?"1":\'0\'},3(7){6(7.r==0){A.O.s(7.i.E)}4.B()},j,j)};4.B=3(){a f=0;a T=0;$(\'.k-2\').N(3(){a X=$(c).9(\'2b\')||0,1k=$(c).9(\'2u\')||0,1a=$(c).9(\'2v\')||0;6($(c).q(\'.W-2\').v(\'b\')){a t=1m($(c).q(\'.1i\').1j());f+=t;a U=l.2t($(c).q(\'.2r\').m());6(1a>0){a F=0;6(X>0){F=X-1k}6(X>t){F=t}6(F<=0){F=0}a 18=t-F;6(18<=0){18=0}T+=1a*F+U*18}w{T+=1m($(c).q(\'.1i\').1j())*U}}4.16($(c).9(\'5\'),t,$(c).9(\'d\'))});$(".f").m(f);2e.2d=f;6(f!=0){$("#1t 1x.1y").2c(f).s()}w{$("#1t 1x.1y").1b()}$(".T").m(l.2k(T,0));6(f<=0){$(".8-14").C(\'11\',1).17(\'8-1A\').15(\'8-1B P\')}w{$(".8-14").Y(\'11\').17(\'8-1B P\').15(\'8-1A\')}$(\'.1z .I-1C\').v(\'b\',$(\'.W-2\').p==$(\'.W-2:b\').p)};4.1e=3(){$(\'.1f .I-1C\').v(\'b\',$(\'.h-2\').p==$(\'.h-2:b\').p);a 1s=$(\'.h-2:b\').p;6(1s>0){$(\'.8-1g\').17(\'P\');$(\'.8-1n\').17(\'P\')}w{$(\'.8-1g\').15(\'P\');$(\'.8-1n\').15(\'P\')}};4.16=3(5,12,d){l.D(\'G/x/16\',{19:5,f:12,d:d},3(7){6(7.r==0){A.O.s(7.i.E)}a 2=$(".k-2[9-5=\'"+5+"\']");6(7.i.2s){2.C(\'9-Q-1T\',2.X);2.C(\'9-Q-U\',2.1a);2.C(\'9-Q-1R\',2.1k)}w{2.Y(\'9-Q-1T\'),2.Y(\'9-Q-U\'),2.Y(\'9-Q-1R\')}},j,j)};4.1S=3(J,d,f,K,1d){l.D(\'G/x/1S\',{19:J,d:d,f:f,K:K},3(7){6(7.r==0){A.O.s(7.i.E);6(7.i.1D){1P(3(){1O.1Q=7.i.1D},2i)}n}6(1d){1d(7.i)}},j,j)};4.u=3(){a o=[];$(\'.h-2:b\').N(3(){a 5=$(c).M(\'.k-2\').9(\'5\');o.1L(5)});6(o.p<=0){n}A.1G(\'确认要从购物车删除吗?\',3(){l.D(\'G/x/u\',{o:o},3(7){6(7.r==0){A.O.s(7.i.E);n}$.N(o,3(){$(".k-2[9-5=\'"+c+"\']").u()});4.B();4.1c()},j,j)})};4.1N=3(){a o=[];$(\'.h-2:b\').N(3(){a 5=$(c).M(\'.k-2\').9(\'5\');o.1L(5)});6(o.p<=0){n}A.1G(\'确认要从购物车移动到关注吗?\',3(){l.D(\'G/x/2j\',{o:o},3(7){6(7.r==0){A.O.s(7.i.E);n}$.N(o,3(){$(".k-2[9-5=\'"+c+"\']").u()});4.B();4.1c()},j,j)})};4.1F=3(8){a z=$(8).M(\'.k-2\');a J=z.9(\'J\'),f=1m(z.q(\'.1i\').1j()),d=z.9(\'d\');a 5=z.9(\'5\');V.2l({J:J,f:f,2h:\'+\',d:d,2g:j,2f:Z,2n:3(f,d,10,1r){6($(\'.R-L\').p>0){a K=R.2o(\'.R-L\');6(!K){n}w{l.D(\'1E/1H/R\',{19:J,5:5,K:K},3(7){$("#1K"+5).C(\'1J\',1r);$(8).m(10);z.9(\'d\',d);z.q(\'.I-1h\').1q(\'1I\',f);$(".k-2[9-5=\'"+5+"\']").q(\'.S .1p-1o\').m(10);4.B()},j,j);V.1M()}}w{$("#1K"+5).C(\'1J\',1r);$(8).m(10);z.9(\'d\',d);z.q(\'.I-1h\').1q(\'1I\',f);$(".k-2[9-5=\'"+5+"\']").q(\'.S .1p-1o\').m(10);4.B();V.1M()}}})};n 4});',62,156,'||item|function|modal|cartid|if|ret|btn|data|var|checked|this|optionid||total|click|edit|result|true|goods|core|html|return|ids|length|find|status|show||remove|prop|else|cart|unbind|goodsitem|FoxUI|caculate|attr|json|message|seckilllast|member|select|fui|goodsid|diyformdata|container|closest|each|toast|disabled|seckill|diyform|cartmode|totalprice|price|picker|check|seckillmaxbuy|removeAttr|false|optiontitle|stop|num|tpl|submit|addClass|update|removeClass|normal|id|seckillprice|hide|changeMode|callback|caculateEdit|editcheckall|delete|number|shownum|val|seckillselfcount|editmode|parseInt|favorite|option|choose|numbers|optionthumb|selects|menucart|checkbox|bindEvents|biz|span|badge|checkall|danger|default|radio|url|order|changeOption|confirm|create|refresh|src|gimg_|push|close|toFavorite|location|setTimeout|href|selfcount|add|maxbuy|getUrl|alert|preventDefault|list|all|empty|content|cart_container|init|plugin|define|get_list|group|tpl_member_cart_footer|footer_container|tpl_member_cart|100|seckillMaxbuy|text|cartcount|window|autoClose|showConfirm|split|800|tofavorite|number_format|open|index|onConfirm|getData|title|prev|marketprice|seckillinfo|getNumber|seckillSelfcount|seckillPrice'.split('|'),0,{}))


define(['core', 'tpl', 'biz/goods/picker', 'biz/plugin/diyform'], function (core, tpl, picker, diyform) {
    var modal = {
        status: 'cart'
    };
    modal.init = function () {
        core.json('member/cart/get_list', {}, function (ret) {
            console.log(ret);
            var result = ret.result;
            if (result.total > 0) {
                $('.btn-edit').show()
            } else {
                $('.btn-edit').hide()
            }
            console.log(ret.result)
            core.tpl("#cart_container", 'tpl_member_cart', ret.result, false);
            core.tpl("#footer_container", 'tpl_member_cart_footer', ret.result, false);
            setTimeout(function () {
                modal.bindEvents()
            }, 100)
        }, true);
        return
    };
    modal.bindEvents = function () {
        $('.fui-number').numbers({
            callback: function (num, container) {
                var cartid = container.closest('.goods-item').data('cartid');
                var optionid = container.closest('.goods-item').data('optionid');
                modal.update(cartid, num, optionid);
                modal.caculate()
            }
        });
        $('.check-item').unbind('click').click(function () {
            var cartid = $(this).closest('.goods-item').data('cartid');
            modal.select(cartid, $(this).prop('checked'))
        });
        $('.checkall').unbind('click').click(function () {
            var checked = $(this).find(':checkbox').prop('checked');
            $(".check-item").prop('checked', checked);
            modal.caculate();
            modal.select('all', checked)
        });
        $('.btn-submit').unbind('click').click(function () {
            var btn = $(this);
            if (btn.attr('stop')) {
                return
            }
            var html = $(this).html();
            btn.attr('stop', 1).html('正在处理...');
            core.json('member/cart/submit', {}, function (ret) {
                if (ret.status != 1) {
                    btn.removeAttr('stop').html(html);
                    if (ret.result == 0) {
                        FoxUI.toast.show(ret.result.message)
                    } else {
                        FoxUI.alert(ret.result.message)
                    }
                    return
                }
                location.href = core.getUrl('order/create')
            }, true)
        });
        $('.btn-edit').unbind('click').click(function () {
            modal.changeMode()
        });
        $('.btn-delete').unbind('click').click(function () {
            if ($('.edit-item:checked').length <= 0) {
                return
            }
            modal.remove()
        });
        $('.btn-favorite').unbind('click').click(function () {
            if ($('.edit-item:checked').length <= 0) {
                return
            }
            modal.toFavorite()
        });
        $('.editcheckall').unbind('click').click(function () {
            var checked = $(this).find(':checkbox').prop('checked');
            $(".edit-item").prop('checked', checked);
            modal.caculateEdit()
        });
        $('.edit-item').unbind('click').click(function () {
            modal.caculateEdit()
        });
        $('.choose-option').unbind('click').click(function (e) {
            if (modal.status == 'edit') {
                e.preventDefault();
                modal.changeOption(this)
            }
        });
        modal.caculate()
    };
    modal.changeMode = function () {
        if ($('.goods-item').length <= 0) {
            $('.btn-edit').remove();
            $('.cartmode').remove();
            $('.editmode').remove();
            $('#container').remove();
            $('.content-empty').show();
            return
        }
        $('.fui-list-group').each(function (index, item) {
            if ($(item).find('.goods-item').length <= 0) {
                $(item).prev('.fui-title').remove();
                $(item).remove()
            }
        });
        if (modal.status == 'cart') {
            $('.edit-item').prop('checked', false);
            $('.editcheckall').prop('checked', false);
            $('.cartmode').hide();
            $('.editmode').show();
            modal.status = 'edit';
            $('.btn-edit').html('完成')
        } else {
            $('.cartmode').show();
            $('.editmode').hide();
            modal.status = 'cart';
            $('.btn-edit').html('编辑')
        }
    };
    modal.select = function (cartid, select) {
        core.json('member/cart/select', {
            id: cartid,
            select: select ? "1" : '0'
        }, function (ret) {
            if (ret.status == 0) {
                FoxUI.toast.show(ret.result.message)
            }
            modal.caculate()
        }, true, true)
    };
    modal.caculate = function () {
        var total = 0;
        var totalprice = 0;
        $('.goods-item').each(function () {
            var seckillmaxbuy = $(this).data('seckillMaxbuy') || 0,
                seckillselfcount = $(this).data('seckillSelfcount') || 0,
                seckillprice = $(this).data('seckillPrice') || 0;
            if ($(this).find('.check-item').prop('checked')) {
                    var t = parseInt($(this).find('.shownum').val());
                    total += t;
                    var price = core.getNumber($(this).find('.marketprice').html());
                    if (seckillprice > 0) {
                        var seckilllast = 0;
                        if (seckillmaxbuy > 0) {
                            seckilllast = seckillmaxbuy - seckillselfcount
                        }
                        if (seckillmaxbuy > t) {
                            seckilllast = t
                        }
                        if (seckilllast <= 0) {
                            seckilllast = 0
                        }
                        var normal = t - seckilllast;
                        if (normal <= 0) {
                            normal = 0
                        }
                        totalprice += seckillprice * seckilllast + price * normal
                    } else {
                        totalprice += parseInt($(this).find('.shownum').val()) * price
                    }

                    $(this).find('.se-total').html(total);
                    console.log(price);
                    $(this).find('.se-totalprice').html(total * price);
                }
                
            modal.update($(this).data('cartid'), t, $(this).data('optionid'))
        });
        $(".total").html(total);
        window.cartcount = total;
        if (total != 0) {
            $("#menucart span.badge").text(total).show()
        } else {
            $("#menucart span.badge").hide()
        }
        $(".totalprice").html(core.number_format(totalprice, 0));
        if (total <= 0) {
            $(".btn-submit").attr('stop', 1).removeClass('btn-danger').addClass('btn-default disabled')
        } else {
            $(".btn-submit").removeAttr('stop').removeClass('btn-default disabled').addClass('btn-danger')
        }
        $('.checkall .fui-radio').prop('checked', $('.check-item').length == $('.check-item:checked').length)
    	console.log(totalprice)
    };
    modal.caculateEdit = function () {
        $('.editcheckall .fui-radio').prop('checked', $('.edit-item').length == $('.edit-item:checked').length);
        var selects = $('.edit-item:checked').length;
        if (selects > 0) {
            $('.btn-delete').removeClass('disabled');
            $('.btn-favorite').removeClass('disabled')
        } else {
            $('.btn-delete').addClass('disabled');
            $('.btn-favorite').addClass('disabled')
        }
    };
    modal.update = function (cartid, num, optionid) {
        core.json('member/cart/update', {
            id: cartid,
            total: num,
            optionid: optionid
        }, function (ret) {
            if (ret.status == 0) {
                FoxUI.toast.show(ret.result.message)
            }
            var item = $(".goods-item[data-cartid='" + cartid + "']");
            if (ret.result.seckillinfo) {
                item.attr('data-seckill-maxbuy', item.seckillmaxbuy);
                item.attr('data-seckill-price', item.seckillprice);
                item.attr('data-seckill-selfcount', item.seckillselfcount)
            } else {
                item.removeAttr('data-seckill-maxbuy'),
                item.removeAttr('data-seckill-price'),
                item.removeAttr('data-seckill-selfcount')
            }
        }, true, true)
    };
    modal.add = function (goodsid, optionid, total, diyformdata, callback) {
        core.json('member/cart/add', {
            id: goodsid,
            optionid: optionid,
            total: total,
            diyformdata: diyformdata
        }, function (ret) {
            if (ret.status == 0) {
                FoxUI.toast.show(ret.result.message);
                if (ret.result.url) {
                    setTimeout(function () {
                        location.href = ret.result.url
                    }, 800)
                }
                return
            }
            if (callback) {
                callback(ret.result)
            }
        }, true, true)
    };
    modal.remove = function () {
        var ids = [];
        $('.edit-item:checked').each(function () {
            var cartid = $(this).closest('.goods-item').data('cartid');
            ids.push(cartid)
        });
        if (ids.length <= 0) {
            return
        }
        FoxUI.confirm('确认要从购物车删除吗?', function () {
            core.json('member/cart/remove', {
                ids: ids
            }, function (ret) {
                if (ret.status == 0) {
                    FoxUI.toast.show(ret.result.message);
                    return
                }
                $.each(ids, function () {
                    $(".goods-item[data-cartid='" + this + "']").remove()
                });
                modal.caculate();
                modal.changeMode()
            }, true, true)
        })
    };
    modal.toFavorite = function () {
        var ids = [];
        $('.edit-item:checked').each(function () {
            var cartid = $(this).closest('.goods-item').data('cartid');
            ids.push(cartid)
        });
        if (ids.length <= 0) {
            return
        }
        FoxUI.confirm('确认要从购物车移动到关注吗?', function () {
            core.json('member/cart/tofavorite', {
                ids: ids
            }, function (ret) {
                if (ret.status == 0) {
                    FoxUI.toast.show(ret.result.message);
                    return
                }
                $.each(ids, function () {
                    $(".goods-item[data-cartid='" + this + "']").remove()
                });
                modal.caculate();
                modal.changeMode()
            }, true, true)
        })
    };
    modal.changeOption = function (btn) {
        var goodsitem = $(btn).closest('.goods-item');
        var goodsid = goodsitem.data('goodsid'),
            total = parseInt(goodsitem.find('.shownum').val()),
            optionid = goodsitem.data('optionid');
        var cartid = goodsitem.data('cartid');
        picker.open({
                goodsid: goodsid,
                total: total,
                split: '+',
                optionid: optionid,
                showConfirm: true,
                autoClose: false,
                onConfirm: function (total, optionid, optiontitle, optionthumb) {
                    if ($('.diyform-container').length > 0) {
                        var diyformdata = diyform.getData('.diyform-container');
                        if (!diyformdata) {
                            return
                        } else {
                            core.json('order/create/diyform', {
                                id: goodsid,
                                cartid: cartid,
                                diyformdata: diyformdata
                            }, function (ret) {
                                $("#gimg_" + cartid).attr('src', optionthumb);
                                $(btn).html(optiontitle);
                                goodsitem.data('optionid', optionid);
                                goodsitem.find('.fui-number').numbers('refresh', total);
                                $(".goods-item[data-cartid='" + cartid + "']").find('.cartmode .choose-option').html(optiontitle);
                                modal.caculate()
                            }, true, true);
                            picker.close()
                        }
                    } else {
                        $("#gimg_" + cartid).attr('src', optionthumb);
                        $(btn).html(optiontitle);
                        goodsitem.data('optionid', optionid);
                        goodsitem.find('.fui-number').numbers('refresh', total);
                        $(".goods-item[data-cartid='" + cartid + "']").find('.cartmode .choose-option').html(optiontitle);
                        modal.caculate();
                        picker.close()
                    }
                }
            })
    };
    return modal
});