// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('1B([\'L\',\'16\',\'1A/t/14\'],5(L,16,14){9 k={v:\'\',1z:\'\',1y:\'\',1C:\'\',1D:\'\',1H:\'\',1G:\'\',r:\'\',8:\'\',B:\'q\',1F:0};9 2={j:1,4:{},1x:T};2.18=5(4){2.4=$.1I(k,4||{});6(!2.15){2.j=1}i{2.15=T}2.n();$(\'1v\').1o(5(){$(\'.x\').D();2.4=k;2.j=1;2.4.v=$(\'#19\').1g();2.n();A T});$(\'#19\').1q(\'1p 1w\',5(){6($.1r($(3).1g())==\'\'){$(\'.x\').D();$(\'.E .7-1e\').a(\'q\').a(\'z\');2.4=k;2.j=1;2.4.v=\'\';2.n()}});$(\'.E .7\').b(5(){9 v=2.4.v;9 8=$(3).g(\'8\')||\'\';6(8==\'\'){6(2.4.8==8){A}2.4=k}i 6(8==\'1f\'){$(3).a(\'z\').a(\'q\');6(2.4.8==8){6(2.4.B==\'q\'){2.4.B=\'z\';$(3).d(\'z\')}i{2.4.B=\'q\';$(3).d(\'q\')}}i{2.4.B=\'z\';$(3).d(\'z\')}2.4.8=8}i 6(8==\'1j\'){6(2.4.8==8){A}2.4=k,2.4.8=\'1j\',2.4.B=\'q\'}$(\'.E .7.s\').a(\'s\'),$(3).d(\'s\');6(8!=\'1f\'){$(\'.E .7-1e\').a(\'q\').a(\'z\')}6(8==\'21\'){2.1k();A}2.4.v=v;2.j=1;$(\'.x\').J(\'\'),$(\'.w-12\').H(),$(".l-D").u();2.n()});$(\'#1Z\').b(5(){6($(3).P(\'p-U\')){$(3).a(\'p-U\').d(\'p-E\')}i{$(3).a(\'p-E\').d(\'p-U\')}$(\'.x\').25(\'24\')});$(\'.e-l\').w({23:5(){2.n()}});2.17()};2.1k=5(){$(\'.e-Q-m\').H().d(\'1n\');$(\'.f\').d(\'1m\');$(\'.f .c\').C(\'b\').b(5(){9 h=$(3).g(\'h\');6($(3).P(\'c-F-o\')){$(3).a(\'c-F-o\').d(\'c-10-o\');$(3).O(\'.p\').u()}i{$(3).a(\'c-10-o\').d(\'c-F-o\');$(3).O(\'.p\').H()}});$(\'.f .1O\').C(\'b\').b(5(){2.1d()});$(\'.f .1N\').C(\'b\').b(5(){$(\'.f .c\').Y(5(){9 h=$(3).g(\'h\');6($(3).P(\'c-F-o\')){2.4[h]="1"}i{2.4[h]=""}});6(2.S){2.4.r=2.S}2.M();$(\'.x\').J(\'\'),$(\'.w-12\').H(),$(".l-D").u();2.j=1,2.n()});2.V();$(\'.e-Q-m\').C(\'b\').b(5(){2.M()})};2.1d=5(){2.M();$(\'.f .c\').Y(5(){6($(3).P(\'c-F-o\')){$(3).a(\'c-F-o\').d(\'c-10-o\');$(3).O(\'.p\').u();2.4[$(3).g(\'h\')]=""}});$(\'.f .r .7 G\').a(\'s\');$(\'.f .r .7:1Q-1U ~ .7\').J(\'\');k.r=\'\';2.4=k,2.n()};2.V=5(){$(\'.f .r .7 G\').C(\'b\').b(5(){9 W=$(3).N(\'.r\').g(\'W\');9 7=$(3).1S();7.O(\'G.s\').a(\'s\');$(3).d(\'s\');9 K=7.g(\'K\');2.S=$(3).g(\'R\');6(K>=W){A}9 1l=$(".f .r .7[g-K=\'"+K+"\'] ~ .7");1l.J(\'\');9 Z=$(3).N(\'.7\').Z(\'.7\');9 X=1L.1K[\'X\'][2.S];9 11="";$.Y(X,5(){11+="<G g-R=\'"+3.R+"\'>"+3.1J+"</G> "});Z.J(11);2.V()})};2.M=5(){$(\'.e-Q-m\').a(\'1n\').1W(5(){$(\'.e-Q-m\').u()});$(\'.f\').a(\'1m\')};2.17=5(){$("#t-13-x .e-t-7").b(5(){2.15=1i});$(\'.1u\').C(\'b\').b(5(){9 I=$(3).N(\'.e-t-7\').g(\'I\');9 h=$(3).N(\'.e-t-7\').g(\'h\');6(h==20){1t.1V=L.1X(\'t/1M\',{R:I})}i{14.1P({I:I,1a:1,1T:0})}})};2.n=5(){2.4.j=2.j;L.1R(\'t/1E\',2.4,5(1b){$(\'.w-12\').u();9 y=1b.y;6(y.1a<=0){$(\'.l-D\').H();$(\'.e-l\').w(\'1h\')}i{$(\'.l-D\').u();$(\'.e-l\').w(\'18\');6(y.13.1c<=0||y.13.1c<y.22){2.1Y=1i;$(\'.e-l\').w(\'1h\')}}2.j++;L.16(\'.x\',\'1s\',y,2.j>1);2.17()})};A 2});',62,130,'||modal|this|params|function|if|item|order|var|removeClass|click|btn|addClass|fui|screen|data|type|else|page|defaults|content||getList||icon|desc|cate|on|goods|hide|keywords|infinite|container|result|asc|return|by|unbind|empty|sort|danger|nav|show|goodsid|html|level|core|closeFilter|closest|find|hasClass|mask|id|lastcateid|false|app|bindCategoryEvents|catlevel|children|each|next|default|HTML|loading|list|picker|toGoods|tpl|bindEvents|init|search|total|ret|length|cancelFilter|price|minprice|val|stop|true|sales|showFilter|items|in|visible|submit|input|bind|trim|tpl_goods_list|location|buy|form|propertychange|lastcate|ishot|isrecommand|biz|define|isnew|isdiscount|get_list|merchid|istime|issendfree|extend|name|category|window|detail|confirm|cancel|open|first|json|parent|optionid|child|href|transitionEnd|getUrl|stopLoading|listblock||filter|pagesize|onLoading|block|toggleClass'.split('|'),0,{}))

define(['core', 'tpl', 'biz/goods/picker'], function (core, tpl, picker) {
    var defaults = {
        keywords: '',
        isrecommand: '',
        ishot: '',
        isnew: '',
        isdiscount: '',
        issendfree: '',
        istime: '',
        cate: '',
        order: '',
        by: 'desc',
        merchid: 0,
        shoppe: ''
    };
    var modal = {
        page: 1,
        params: {},
        lastcate: false
    };
    modal.init = function (params) {
        modal.params = $.extend(defaults, params || {});
        if (!modal.toGoods) {
            modal.page = 1
        } else {
            modal.toGoods = false
        }
        modal.getList();
        $('form').submit(function () {
            $('.container').empty();
            modal.params = defaults;
            modal.page = 1;
            modal.params.keywords = $('#search').val();
            modal.getList();
            return false
        });
        $('#search').bind('input propertychange', function () {
            if ($.trim($(this).val()) == '') {
                $('.container').empty();
                $('.sort .item-price').removeClass('desc').removeClass('asc');
                modal.params = defaults;
                modal.page = 1;
                modal.params.keywords = '';
                modal.getList()
            }
        });
        $('.sort .item').click(function () {
            var keywords = modal.params.keywords;
            var order = $(this).data('order') || '';
            if (order == '') {
                if (modal.params.order == order) {
                    return
                }
                modal.params = defaults
            } else if (order == 'minprice') {
                $(this).removeClass('asc').removeClass('desc');
                if (modal.params.order == order) {
                    if (modal.params.by == 'desc') {
                        modal.params.by = 'asc';
                        $(this).addClass('asc')
                    } else {
                        modal.params.by = 'desc';
                        $(this).addClass('desc')
                    }
                } else {
                    modal.params.by = 'asc';
                    $(this).addClass('asc')
                }
                modal.params.order = order
            } else if (order == 'sales') {
                if (modal.params.order == order) {
                    return
                }
                modal.params = defaults,
                modal.params.order = 'sales',
                modal.params.by = 'desc'
            }
            $('.sort .item.on').removeClass('on'),
            $(this).addClass('on');
            if (order != 'minprice') {
                $('.sort .item-price').removeClass('desc').removeClass('asc')
            }
            if (order == 'filter') {
                modal.showFilter();
                return
            }
            modal.params.keywords = keywords;
            modal.page = 1;
            $('.container').html(''),
            $('.infinite-loading').show(),
            $(".content-empty").hide();
            modal.getList()
        });
        $('#listblock').click(function () {
            if ($(this).hasClass('icon-app')) {
                $(this).removeClass('icon-app').addClass('icon-sort')
            } else {
                $(this).removeClass('icon-sort').addClass('icon-app')
            }
            $('.container').toggleClass('block')
        });
        $('.fui-content').infinite({
            onLoading: function () {
                modal.getList()
            }
        });
        modal.bindEvents()
    };
    modal.showFilter = function () {
        $('.fui-mask-m').show().addClass('visible');
        $('.screen').addClass('in');
        $('.screen .btn').unbind('click').click(function () {
            var type = $(this).data('type');
            if ($(this).hasClass('btn-danger-o')) {
                $(this).removeClass('btn-danger-o').addClass('btn-default-o');
                $(this).find('.icon').hide()
            } else {
                $(this).removeClass('btn-default-o').addClass('btn-danger-o');
                $(this).find('.icon').show()
            }
        });
        $('.screen .cancel').unbind('click').click(function () {
            modal.cancelFilter()
        });
        $('.screen .confirm').unbind('click').click(function () {
            $('.screen .btn').each(function () {
                var type = $(this).data('type');
                if ($(this).hasClass('btn-danger-o')) {
                    modal.params[type] = "1"
                } else {
                    modal.params[type] = ""
                }
            });
            if (modal.lastcateid) {
                modal.params.cate = modal.lastcateid
            }
            modal.closeFilter();
            $('.container').html(''),
            $('.infinite-loading').show(),
            $(".content-empty").hide();
            modal.page = 1,
            modal.getList()
        });
        modal.bindCategoryEvents();
        $('.fui-mask-m').unbind('click').click(function () {
            modal.closeFilter()
        })
    };
    modal.cancelFilter = function () {
        modal.closeFilter();
        $('.screen .btn').each(function () {
            if ($(this).hasClass('btn-danger-o')) {
                $(this).removeClass('btn-danger-o').addClass('btn-default-o');
                $(this).find('.icon').hide();
                modal.params[$(this).data('type')] = ""
            }
        });
        $('.screen .cate .item nav').removeClass('on');
        $('.screen .cate .item:first-child ~ .item').html('');
        defaults.cate = '';
        modal.params = defaults,
        modal.getList()
    };
    modal.bindCategoryEvents = function () {
        $('.screen .cate .item nav').unbind('click').click(function () {
            var catlevel = $(this).closest('.cate').data('catlevel');
            var item = $(this).parent();
            item.find('nav.on').removeClass('on');
            $(this).addClass('on');
            var level = item.data('level');
            modal.lastcateid = $(this).data('id');
            if (level >= catlevel) {
                return
            }
            var items = $(".screen .cate .item[data-level='" + level + "'] ~ .item");
            items.html('');
            var next = $(this).closest('.item').next('.item');
            var children = window.category['children'][modal.lastcateid];
            var HTML = "";
            $.each(children, function () {
                HTML += "<nav data-id='" + this.id + "'>" + this.name + "</nav> "
            });
            next.html(HTML);
            modal.bindCategoryEvents()
        })
    };
    modal.closeFilter = function () {
        $('.fui-mask-m').removeClass('visible').transitionEnd(function () {
            $('.fui-mask-m').hide()
        });
        $('.screen').removeClass('in')
    };
    modal.bindEvents = function () {
        $("#goods-list-container .fui-goods-item").click(function () {
            modal.toGoods = true
        });
        $('.buy').unbind('click').click(function () {
            var goodsid = $(this).closest('.fui-goods-item').data('goodsid');
            var type = $(this).closest('.fui-goods-item').data('type');
            if (type == 20) {
                location.href = core.getUrl('goods/detail', {
                    id: goodsid
                })
            } else {
                picker.open({
                    goodsid: goodsid,
                    total: 1,
                    optionid: 0
                })
            }
        })
    };
    modal.getList = function () {
        modal.params.page = modal.page;
        core.json('shoppe/get_list', modal.params, function (ret) {
            console.log('getList', ret.result.list)
            $('.infinite-loading').hide();
            var result = ret.result;
            if (result.total <= 0) {
                $('.content-empty').show();
                $('.fui-content').infinite('stop')
            } else {
                $('.content-empty').hide();
                $('.fui-content').infinite('init');
                if (result.list.length <= 0 || result.list.length < result.pagesize) {
                    modal.stopLoading = true;
                    $('.fui-content').infinite('stop')
                }
            }
            modal.page++;
            core.tpl('.container', 'tpl_goods_list', result, modal.page > 1);
            modal.bindEvents()
        })
    };
    return modal
});